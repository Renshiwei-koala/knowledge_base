# 角色权限管理环境搭建

## 遇到问题

1. Spring官方更加推荐使用构造器注入的方式注入依赖，但是依赖注入出现空指针异常？

2. 1. springboot的默认启动类AppRun需要放在根目录下的包下，多模块开发，多个包的根包命名必须一致，否则会出现spring自动注入失败，报空指针的错误
   2. 主要用的是@SpringBootApplication引起的问题

2. 

```java
Parameter 0 of constructor in com.test.modules.business.controller.DeptController required a single bean, but 2 were found:
	- deptServiceImpl: defined in file [D:\IDE\IDEA\test\env_project_test\env_system\target\classes\com\test\modules\business\service\impl\DeptServiceImpl.class]
	- IDeptService: defined in file [D:\IDE\IDEA\test\env_project_test\env_system\target\classes\com\test\modules\business\service\IDeptService.class]


Action:

Consider marking one of the beans as @Primary, updating the consumer to accept multiple beans, or using @Qualifier to identify the bean that should be consumed
```



现在实现类上加@Primary注解，解决问题吧

很奇怪，以前这样都没有问题



3. mybatisplus在使用逻辑删除，即数据库时`is_delete`时，查询会进行起别名为`delete`，为数据库关键字，会报错

```java
SELECT id,name,sort,dept_id,create_time,update_time,is_delete AS delete FROM job WHERE id=1 
AND is_delete=0 ;
```



4. mybatisplus在继承之后，一直不能输出继承父类的user信息，开始一直以为是mybatis底层的数据组装问题。直到输出一个user的get方法后，才明白数据是组装进去了了。只是没有调用父级的toString()方法，而导致输出不出来父类的信息。

   ```java
   UserDetailsBO(super=User(id=3, username=rsw, nickname=测试管理员, sex=false, phone=15670533573, email=1487660836@qq.com, avatar=null, password=$2a$10$HhxyGZy.ulf3RvAwaHUGb.k.2i9PBpv4YbLMJWp8pES7pPhTyRCF., deptId=null, jobId=null, lastPasswordResetTime=2020-08-06T23:12:41, createTime=2020-08-06T23:12:56, updateTime=2020-08-07T11:21:10, deleted=false), job=Job(id=13, name=校团委主席, sort=1, deptId=1, createTime=2020-08-07T11:17:40, updateTime=2020-08-07T11:17:40, deleted=false), dept=DeptSmallBO(id=1, name=河南科技学院, roles=[RoleSmallBO(id=1, name=超级管理员, level=1, dataScope=全部, permission=admin)]))
   ```

   ```
   测试管理员UserDetailsBO(job=Job(id=13, name=校团委主席, sort=1, deptId=1, createTime=2020-08-07T11:17:40, updateTime=2020-08-07T11:17:40, deleted=false), dept=DeptSmallBO(id=1, name=河南科技学院, roles=[RoleSmallBO(id=1, name=超级管理员, level=1, dataScope=全部, permission=admin)]))
   ```

5. fastjson在1.2.62有bug

   ```
   Caused by: java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;
   ```

   https://github.com/alibaba/fastjson/issues/2780

6. accessDeniedHandler 无效，被全局异常捕获了

   ```java
   env_test- 2020-08-07 16:57:53 [http-nio-9002-exec-1] ERROR c.t.e.handler.GlobalExceptionHandler - 不允许访问
   org.springframework.security.access.AccessDeniedException: 不允许访问
   	at org.springframework.security.access.vote.AffirmativeBased.decide(AffirmativeBased.java:84)
   	at org.springframework.security.access.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:233)
   ```

   解决1：在全局异常处理中加入对AccessDeniedException的捕获处理

   https://blog.csdn.net/liuyuncd/article/details/103863695

7. 后端小程序获取用户信息报错

   ```
   java.security.spec.InvalidParameterSpecException: IV not 16 bytes long
   ```

   解决：使用commons-codec的base64解密没问题，但是使用hutool的就会出现这个问题。

8. 微信小程序登录报错encryptedData的错误

   ```java
   Cipher cipher = Cipher.getInstance("AES/CBC/PKCS7Padding", "BC");
   byte[] resultByte = cipher.doFinal(dataByte);
   ```

   ```
   javax.crypto.BadPaddingException: pad block corrupted
   ```

   使用微信开发者工具登录时，需要清除缓存就可以了

9. 去重语句使用关键字分组去重，mysql报错

```
Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'xiaoyun_notice.ou.user_id' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by
```

```mysql
SELECT ou.obj_id,ou.user_id,ou.`option`,ou.option_time,ou.check_time,ou.view_time,ou.is_read,COUNT(DISTINCT ou.obj_id) 
            FROM object_user ou LEFT JOIN object ON object.id=ou.obj_id 
            WHERE (user_id=145 OR owner_id=145) and ou.status=0 GROUP BY ou.obj_id ORDER BY object.created_at DESC;
```

解决办法：[https://www.cnblogs.com/ewei/p/13050408.html](https://www.cnblogs.com/ewei/p/13050408.html)

10. 搭建环境，如果后端和前端代码要求放在一个仓库，而且还要前后端分离的话。使用idea编辑器，需要进入这个文件夹然后在根目录下创建后端项目文件夹，否则项目会运行异常（==类找不到，参数类型不对应等异常==）。

    ![image-20200812085556937](https://gitee.com/koala010/typora/raw/master/img/image-20200812085556937.png)

    ![image-20200812085837173](https://gitee.com/koala010/typora/raw/master/img/image-20200812085837173.png)

